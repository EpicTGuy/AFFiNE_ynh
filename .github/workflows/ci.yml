name: CI AFFiNE YunoHost

on:
  push:
    branches: [ testing ]
  pull_request:
    branches: [ testing ]

env:
  TEST_DOMAIN: test.example.com
  TEST_PATH: /affine
  TEST_IS_PUBLIC: false
  TIMEOUT: 600

jobs:
  # Job 1: Lint Shell (shellcheck)
  lint-shell:
    name: "ğŸ” Lint Shell (shellcheck)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run shellcheck on scripts
        run: |
          echo "ğŸ” VÃ©rification des scripts avec shellcheck..."
          find scripts/ -name "*.sh" -type f -exec shellcheck {} \;
          echo "âœ… Tous les scripts passent shellcheck"

      - name: Check script permissions
        run: |
          echo "ğŸ” VÃ©rification des permissions des scripts..."
          for script in scripts/*.sh; do
            if [ -f "$script" ]; then
              if [ ! -x "$script" ]; then
                echo "âŒ Script non exÃ©cutable: $script"
                exit 1
              fi
              echo "âœ… $script est exÃ©cutable"
            fi
          done
          echo "âœ… Tous les scripts ont les bonnes permissions"

  # Job 2: Test Install/Remove
  test-install-remove:
    name: "ğŸš€ Test Install/Remove"
    runs-on: ubuntu-latest
    needs: lint-shell
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup YunoHost environment
        run: |
          echo "ğŸ”§ Configuration de l'environnement YunoHost..."
          # Installation des dÃ©pendances de base
          sudo apt-get update
          sudo apt-get install -y \
            yunohost \
            nodejs \
            npm \
            nginx \
            postgresql \
            postgresql-contrib \
            redis-server \
            jq \
            bc \
            curl \
            wget \
            git \
            build-essential \
            python3 \
            python3-pip

      - name: Start services
        run: |
          echo "ğŸš€ DÃ©marrage des services..."
          sudo systemctl start postgresql
          sudo systemctl start redis-server
          sudo systemctl start nginx
          
          # VÃ©rification des services
          sudo systemctl is-active postgresql || exit 1
          sudo systemctl is-active redis-server || exit 1
          sudo systemctl is-active nginx || exit 1
          echo "âœ… Tous les services sont dÃ©marrÃ©s"

      - name: Configure YunoHost
        run: |
          echo "âš™ï¸ Configuration de YunoHost..."
          # Configuration minimale pour les tests
          sudo yunohost tools postinstall \
            --domain ${{ env.TEST_DOMAIN }} \
            --password "testpassword123" \
            --ask-question=false || true

      - name: Run install test
        run: |
          echo "ğŸ§ª ExÃ©cution du test d'installation..."
          cd scripts
          chmod +x *.sh
          ./install.sh
          echo "âœ… Test d'installation rÃ©ussi"

      - name: Run remove test
        run: |
          echo "ğŸ§ª ExÃ©cution du test de dÃ©sinstallation..."
          cd scripts
          ./remove.sh
          echo "âœ… Test de dÃ©sinstallation rÃ©ussi"

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Nettoyage..."
          sudo yunohost app remove affine 2>/dev/null || true
          sudo systemctl stop nginx postgresql redis-server || true

  # Job 3: Test Backup/Restore
  test-backup-restore:
    name: "ğŸ’¾ Test Backup/Restore"
    runs-on: ubuntu-latest
    needs: lint-shell
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup YunoHost environment
        run: |
          echo "ğŸ”§ Configuration de l'environnement YunoHost..."
          sudo apt-get update
          sudo apt-get install -y \
            yunohost \
            nodejs \
            npm \
            nginx \
            postgresql \
            postgresql-contrib \
            redis-server \
            jq \
            bc \
            curl \
            wget \
            git \
            build-essential \
            python3 \
            python3-pip

      - name: Start services
        run: |
          echo "ğŸš€ DÃ©marrage des services..."
          sudo systemctl start postgresql
          sudo systemctl start redis-server
          sudo systemctl start nginx
          
          # VÃ©rification des services
          sudo systemctl is-active postgresql || exit 1
          sudo systemctl is-active redis-server || exit 1
          sudo systemctl is-active nginx || exit 1
          echo "âœ… Tous les services sont dÃ©marrÃ©s"

      - name: Configure YunoHost
        run: |
          echo "âš™ï¸ Configuration de YunoHost..."
          sudo yunohost tools postinstall \
            --domain ${{ env.TEST_DOMAIN }} \
            --password "testpassword123" \
            --ask-question=false || true

      - name: Run backup/restore test
        run: |
          echo "ğŸ§ª ExÃ©cution du test backup/restore..."
          cd scripts
          chmod +x *.sh
          ./backup_restore.sh
          echo "âœ… Test backup/restore rÃ©ussi"

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Nettoyage..."
          sudo yunohost app remove affine 2>/dev/null || true
          sudo systemctl stop nginx postgresql redis-server || true

  # Job 4: Test Multi-instance
  test-multi-instance:
    name: "ğŸ”„ Test Multi-instance"
    runs-on: ubuntu-latest
    needs: lint-shell
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup YunoHost environment
        run: |
          echo "ğŸ”§ Configuration de l'environnement YunoHost..."
          sudo apt-get update
          sudo apt-get install -y \
            yunohost \
            nodejs \
            npm \
            nginx \
            postgresql \
            postgresql-contrib \
            redis-server \
            jq \
            bc \
            curl \
            wget \
            git \
            build-essential \
            python3 \
            python3-pip

      - name: Start services
        run: |
          echo "ğŸš€ DÃ©marrage des services..."
          sudo systemctl start postgresql
          sudo systemctl start redis-server
          sudo systemctl start nginx
          
          # VÃ©rification des services
          sudo systemctl is-active postgresql || exit 1
          sudo systemctl is-active redis-server || exit 1
          sudo systemctl is-active nginx || exit 1
          echo "âœ… Tous les services sont dÃ©marrÃ©s"

      - name: Configure YunoHost
        run: |
          echo "âš™ï¸ Configuration de YunoHost..."
          sudo yunohost tools postinstall \
            --domain ${{ env.TEST_DOMAIN }} \
            --password "testpassword123" \
            --ask-question=false || true

      - name: Run multi-instance test
        run: |
          echo "ğŸ§ª ExÃ©cution du test multi-instance..."
          cd scripts
          chmod +x *.sh
          ./multi_instance.sh
          echo "âœ… Test multi-instance rÃ©ussi"

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Nettoyage..."
          sudo yunohost app remove affine_1 2>/dev/null || true
          sudo yunohost app remove affine_2 2>/dev/null || true
          sudo systemctl stop nginx postgresql redis-server || true

  # Job 5: Test Upgrade
  test-upgrade:
    name: "â¬†ï¸ Test Upgrade"
    runs-on: ubuntu-latest
    needs: lint-shell
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup YunoHost environment
        run: |
          echo "ğŸ”§ Configuration de l'environnement YunoHost..."
          sudo apt-get update
          sudo apt-get install -y \
            yunohost \
            nodejs \
            npm \
            nginx \
            postgresql \
            postgresql-contrib \
            redis-server \
            jq \
            bc \
            curl \
            wget \
            git \
            build-essential \
            python3 \
            python3-pip

      - name: Start services
        run: |
          echo "ğŸš€ DÃ©marrage des services..."
          sudo systemctl start postgresql
          sudo systemctl start redis-server
          sudo systemctl start nginx
          
          # VÃ©rification des services
          sudo systemctl is-active postgresql || exit 1
          sudo systemctl is-active redis-server || exit 1
          sudo systemctl is-active nginx || exit 1
          echo "âœ… Tous les services sont dÃ©marrÃ©s"

      - name: Configure YunoHost
        run: |
          echo "âš™ï¸ Configuration de YunoHost..."
          sudo yunohost tools postinstall \
            --domain ${{ env.TEST_DOMAIN }} \
            --password "testpassword123" \
            --ask-question=false || true

      - name: Run upgrade test
        run: |
          echo "ğŸ§ª ExÃ©cution du test d'upgrade..."
          cd scripts
          chmod +x *.sh
          ./upgrade.sh
          echo "âœ… Test d'upgrade rÃ©ussi"

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Nettoyage..."
          sudo yunohost app remove affine 2>/dev/null || true
          sudo systemctl stop nginx postgresql redis-server || true

  # Job 6: Test complet (tous les tests)
  test-all:
    name: "ğŸ¯ Test Complet (Tous les tests)"
    runs-on: ubuntu-latest
    needs: [lint-shell, test-install-remove, test-backup-restore, test-multi-instance, test-upgrade]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup YunoHost environment
        run: |
          echo "ğŸ”§ Configuration de l'environnement YunoHost..."
          sudo apt-get update
          sudo apt-get install -y \
            yunohost \
            nodejs \
            npm \
            nginx \
            postgresql \
            postgresql-contrib \
            redis-server \
            jq \
            bc \
            curl \
            wget \
            git \
            build-essential \
            python3 \
            python3-pip

      - name: Start services
        run: |
          echo "ğŸš€ DÃ©marrage des services..."
          sudo systemctl start postgresql
          sudo systemctl start redis-server
          sudo systemctl start nginx
          
          # VÃ©rification des services
          sudo systemctl is-active postgresql || exit 1
          sudo systemctl is-active redis-server || exit 1
          sudo systemctl is-active nginx || exit 1
          echo "âœ… Tous les services sont dÃ©marrÃ©s"

      - name: Configure YunoHost
        run: |
          echo "âš™ï¸ Configuration de YunoHost..."
          sudo yunohost tools postinstall \
            --domain ${{ env.TEST_DOMAIN }} \
            --password "testpassword123" \
            --ask-question=false || true

      - name: Run all tests
        run: |
          echo "ğŸ§ª ExÃ©cution de tous les tests..."
          cd scripts
          chmod +x *.sh
          ./run_all_tests.sh
          echo "âœ… Tous les tests sont rÃ©ussis"

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: /tmp/affine_tests/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ Nettoyage final..."
          sudo yunohost app remove affine 2>/dev/null || true
          sudo yunohost app remove affine_1 2>/dev/null || true
          sudo yunohost app remove affine_2 2>/dev/null || true
          sudo systemctl stop nginx postgresql redis-server || true

  # Job 7: Calcul du niveau YunoHost
  calculate-level:
    name: "ğŸ“Š Calcul du Niveau YunoHost"
    runs-on: ubuntu-latest
    needs: [test-all]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Calculate YunoHost level
        run: |
          echo "ğŸ“Š Calcul du niveau YunoHost..."
          
          # Simulation du calcul de niveau basÃ© sur les tests
          LEVEL=0
          
          # Test de lint shell (niveau 1)
          if [ "${{ needs.lint-shell.result }}" == "success" ]; then
            LEVEL=$((LEVEL + 1))
            echo "âœ… Lint shell: +1 niveau"
          else
            echo "âŒ Lint shell: Ã©chec"
          fi
          
          # Test install/remove (niveau 2)
          if [ "${{ needs.test-install-remove.result }}" == "success" ]; then
            LEVEL=$((LEVEL + 1))
            echo "âœ… Install/Remove: +1 niveau"
          else
            echo "âŒ Install/Remove: Ã©chec"
          fi
          
          # Test backup/restore (niveau 3)
          if [ "${{ needs.test-backup-restore.result }}" == "success" ]; then
            LEVEL=$((LEVEL + 1))
            echo "âœ… Backup/Restore: +1 niveau"
          else
            echo "âŒ Backup/Restore: Ã©chec"
          fi
          
          # Test multi-instance (niveau 4)
          if [ "${{ needs.test-multi-instance.result }}" == "success" ]; then
            LEVEL=$((LEVEL + 1))
            echo "âœ… Multi-instance: +1 niveau"
          else
            echo "âŒ Multi-instance: Ã©chec"
          fi
          
          # Test upgrade (niveau 5)
          if [ "${{ needs.test-upgrade.result }}" == "success" ]; then
            LEVEL=$((LEVEL + 1))
            echo "âœ… Upgrade: +1 niveau"
          else
            echo "âŒ Upgrade: Ã©chec"
          fi
          
          # Test complet (niveau 6)
          if [ "${{ needs.test-all.result }}" == "success" ]; then
            LEVEL=$((LEVEL + 1))
            echo "âœ… Test complet: +1 niveau"
          else
            echo "âŒ Test complet: Ã©chec"
          fi
          
          echo "ğŸ¯ Niveau final: $LEVEL"
          
          # VÃ©rification du niveau minimum requis
          if [ $LEVEL -ge 6 ]; then
            echo "âœ… Niveau requis atteint (â‰¥6)"
            echo "LEVEL=$LEVEL" >> $GITHUB_ENV
            echo "LEVEL_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ Niveau insuffisant (<6)"
            echo "LEVEL=$LEVEL" >> $GITHUB_ENV
            echo "LEVEL_STATUS=failure" >> $GITHUB_ENV
            exit 1
          fi

      - name: Set level badge
        if: always()
        run: |
          echo "ğŸ† Niveau YunoHost: ${{ env.LEVEL }}"
          echo "ğŸ“Š Statut: ${{ env.LEVEL_STATUS }}"
# CI Trigger
