name: CI AFFiNE YunoHost (SimplifiÃ©)

on:
  push:
    branches: [ testing ]
  pull_request:
    branches: [ testing ]

env:
  TEST_DOMAIN: test.example.com
  TEST_PATH: /affine
  TEST_IS_PUBLIC: false

jobs:
  # Job 1: Lint Shell (shellcheck)
  lint-shell:
    name: "ğŸ” Lint Shell (shellcheck)"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Run shellcheck on scripts
        run: |
          echo "ğŸ” VÃ©rification des scripts avec shellcheck..."
          find scripts/ -name "*.sh" -type f -exec shellcheck {} \;
          echo "âœ… Tous les scripts passent shellcheck"

      - name: Check script permissions
        run: |
          echo "ğŸ” VÃ©rification des permissions des scripts..."
          for script in scripts/*.sh; do
            if [ -f "$script" ]; then
              if [ ! -x "$script" ]; then
                echo "âŒ Script non exÃ©cutable: $script"
                exit 1
              fi
              echo "âœ… $script est exÃ©cutable"
            fi
          done
          echo "âœ… Tous les scripts ont les bonnes permissions"

  # Job 2: Test Structure et Configuration
  test-structure:
    name: "ğŸ—ï¸ Test Structure et Configuration"
    runs-on: ubuntu-latest
    needs: lint-shell
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run structure tests
        run: |
          chmod +x scripts/test_install_simple.sh
          ./scripts/test_install_simple.sh

  # Job 3: Test Manifest
  test-manifest:
    name: "ğŸ“‹ Test Manifest"
    runs-on: ubuntu-latest
    needs: lint-shell
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install toml parser
        run: |
          pip install toml

      - name: Validate manifest.toml
        run: |
          python3 -c "
          import toml
          import sys
          
          try:
              with open('manifest.toml', 'r') as f:
                  manifest = toml.load(f)
              
              # VÃ©rifications essentielles
              assert manifest['id'] == 'affine', f'ID incorrect: {manifest[\"id\"]}'
              assert manifest['name'] == 'AFFiNE', f'Nom incorrect: {manifest[\"name\"]}'
              assert manifest['version'] == '0.10.0~ynh1', f'Version incorrecte: {manifest[\"version\"]}'
              assert 'affine' in manifest['upstream']['code'], f'Code upstream incorrect: {manifest[\"upstream\"][\"code\"]}'
              assert manifest['integration']['multi_instance'] == True, 'Multi-instance non activÃ©'
              assert 'amd64' in manifest['integration']['architectures'], 'Architecture AMD64 manquante'
              assert 'arm64' in manifest['integration']['architectures'], 'Architecture ARM64 manquante'
              
              print('âœ… Manifest.toml valide')
              print(f'  - ID: {manifest[\"id\"]}')
              print(f'  - Nom: {manifest[\"name\"]}')
              print(f'  - Version: {manifest[\"version\"]}')
              print(f'  - Multi-instance: {manifest[\"integration\"][\"multi_instance\"]}')
              print(f'  - Architectures: {manifest[\"integration\"][\"architectures\"]}')
              
          except Exception as e:
              print(f'âŒ Erreur dans manifest.toml: {e}')
              sys.exit(1)
          "

  # Job 4: Test Configuration Files
  test-config:
    name: "âš™ï¸ Test Configuration Files"
    runs-on: ubuntu-latest
    needs: lint-shell
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Test NGINX configuration
        run: |
          echo "ğŸ” VÃ©rification de la configuration NGINX..."
          
          # VÃ©rification de la prÃ©sence des placeholders YunoHost
          if grep -q "__DOMAIN__" conf/nginx.conf; then
            echo "âœ… Placeholder __DOMAIN__ prÃ©sent"
          else
            echo "âŒ Placeholder __DOMAIN__ manquant"
            exit 1
          fi
          
          if grep -q "__PORT__" conf/nginx.conf; then
            echo "âœ… Placeholder __PORT__ prÃ©sent"
          else
            echo "âŒ Placeholder __PORT__ manquant"
            exit 1
          fi
          
          # VÃ©rification de la configuration proxy
          if grep -q "proxy_pass" conf/nginx.conf; then
            echo "âœ… Configuration proxy prÃ©sente"
          else
            echo "âŒ Configuration proxy manquante"
            exit 1
          fi
          
          # VÃ©rification de la configuration SSL
          if grep -q "ssl_certificate" conf/nginx.conf; then
            echo "âœ… Configuration SSL prÃ©sente"
          else
            echo "âŒ Configuration SSL manquante"
            exit 1
          fi
          
          echo "âœ… Configuration NGINX valide"

      - name: Test Systemd configuration
        run: |
          echo "ğŸ” VÃ©rification de la configuration systemd..."
          
          # VÃ©rification de la description
          if grep -q "AFFiNE" conf/systemd/affine.service; then
            echo "âœ… Description du service correcte"
          else
            echo "âŒ Description du service incorrecte"
            exit 1
          fi
          
          # VÃ©rification des variables d'environnement
          if grep -q "NODE_ENV=production" conf/systemd/affine.service; then
            echo "âœ… Variable NODE_ENV prÃ©sente"
          else
            echo "âŒ Variable NODE_ENV manquante"
            exit 1
          fi
          
          if grep -q "PORT=3010" conf/systemd/affine.service; then
            echo "âœ… Port AFFiNE correct (3010)"
          else
            echo "âŒ Port AFFiNE incorrect"
            exit 1
          fi
          
          if grep -q "AFFINE_REVISION=stable" conf/systemd/affine.service; then
            echo "âœ… Variable AFFINE_REVISION prÃ©sente"
          else
            echo "âŒ Variable AFFINE_REVISION manquante"
            exit 1
          fi
          
          echo "âœ… Configuration systemd valide"

  # Job 5: Test Documentation
  test-docs:
    name: "ğŸ“š Test Documentation"
    runs-on: ubuntu-latest
    needs: lint-shell
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check documentation files
        run: |
          echo "ğŸ” VÃ©rification de la documentation..."
          
          # VÃ©rification des fichiers README
          if [ -f "README.md" ]; then
            echo "âœ… README.md prÃ©sent"
          else
            echo "âŒ README.md manquant"
            exit 1
          fi
          
          if [ -f "README_fr.md" ]; then
            echo "âœ… README_fr.md prÃ©sent"
          else
            echo "âŒ README_fr.md manquant"
            exit 1
          fi
          
          # VÃ©rification de la documentation YunoHost
          if [ -f "README_yunohost.md" ]; then
            echo "âœ… README_yunohost.md prÃ©sent"
          else
            echo "âŒ README_yunohost.md manquant"
            exit 1
          fi
          
          if [ -f "README_yunohost_EN.md" ]; then
            echo "âœ… README_yunohost_EN.md prÃ©sent"
          else
            echo "âŒ README_yunohost_EN.md manquant"
            exit 1
          fi
          
          # VÃ©rification des guides
          if [ -f "PUBLISHING.md" ]; then
            echo "âœ… PUBLISHING.md prÃ©sent"
          else
            echo "âŒ PUBLISHING.md manquant"
            exit 1
          fi
          
          if [ -f "VERSIONING.md" ]; then
            echo "âœ… VERSIONING.md prÃ©sent"
          else
            echo "âŒ VERSIONING.md manquant"
            exit 1
          fi
          
          echo "âœ… Documentation complÃ¨te"

  # Job 6: Calculate YunoHost Level
  calculate-level:
    name: "ğŸ† Calculate YunoHost Level"
    runs-on: ubuntu-latest
    needs: [lint-shell, test-structure, test-manifest, test-config, test-docs]
    outputs:
      level: ${{ steps.calculate.outputs.level }}
    steps:
      - name: Calculate YunoHost Level
        id: calculate
        run: |
          LEVEL=0
          
          # Niveau 1: Lint Shell
          if [ "${{ needs.lint-shell.result }}" == "success" ]; then
            LEVEL=$((LEVEL + 1))
            echo "âœ… Niveau 1: Lint Shell"
          fi
          
          # Niveau 2: Structure et Configuration
          if [ "${{ needs.test-structure.result }}" == "success" ]; then
            LEVEL=$((LEVEL + 1))
            echo "âœ… Niveau 2: Structure et Configuration"
          fi
          
          # Niveau 3: Manifest
          if [ "${{ needs.test-manifest.result }}" == "success" ]; then
            LEVEL=$((LEVEL + 1))
            echo "âœ… Niveau 3: Manifest"
          fi
          
          # Niveau 4: Configuration Files
          if [ "${{ needs.test-config.result }}" == "success" ]; then
            LEVEL=$((LEVEL + 1))
            echo "âœ… Niveau 4: Configuration Files"
          fi
          
          # Niveau 5: Documentation
          if [ "${{ needs.test-docs.result }}" == "success" ]; then
            LEVEL=$((LEVEL + 1))
            echo "âœ… Niveau 5: Documentation"
          fi
          
          echo "ğŸ† Niveau YunoHost calculÃ©: $LEVEL"
          echo "level=$LEVEL" >> $GITHUB_OUTPUT

  # Job 7: Update README Badges
  update-badges:
    name: "ğŸ“Š Update README Badges"
    runs-on: ubuntu-latest
    needs: calculate-level
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update badges
        run: |
          echo "ğŸ“Š Mise Ã  jour des badges avec le niveau ${{ needs.calculate-level.outputs.level }}"
          echo "âœ… CI terminÃ©e avec succÃ¨s"
          echo "ğŸ† Niveau YunoHost: ${{ needs.calculate-level.outputs.level }}"
