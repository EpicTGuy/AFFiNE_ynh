#!/bin/bash

# Script de sauvegarde pour AFFiNE
# BasÃ© sur example_ynh avec stubs utilisant ynh_*

set -e

# Chargement des helpers YunoHost
source /usr/share/yunohost/helpers

# Variables de configuration
APP_ID="affine"

# RÃ©cupÃ©ration de l'instance depuis les paramÃ¨tres YunoHost
INSTANCE_ID=$(ynh_app_setting_get "$APP_ID" "instance_id")
if [ -z "$INSTANCE_ID" ]; then
    ynh_log_error "Instance ID non trouvÃ©"
    exit 1
fi

# Configuration multi-instance
APP_USER="${APP_ID}_${INSTANCE_ID}"
APP_GROUP="${APP_ID}_${INSTANCE_ID}"
APP_DIR="/var/www/${APP_ID}_${INSTANCE_ID}"
APP_DATA_DIR="$APP_DIR/data"
APP_CONFIG_DIR="$APP_DIR/config"
APP_LOG_DIR="/var/log/${APP_ID}_${INSTANCE_ID}"
APP_SOURCE_DIR="$APP_DIR/source"
APP_BACKUP_DIR="/opt/yunohost/backup/${APP_ID}_${INSTANCE_ID}"

# RÃ©cupÃ©ration des paramÃ¨tres de l'application
DB_NAME=$(ynh_app_setting_get "$APP_ID" "db_name")
REDIS_DB=$(ynh_app_setting_get "$APP_ID" "redis_db")

# Fonction de nettoyage en cas d'erreur
cleanup_on_error() {
    ynh_clean_setup
    exit 1
}

# Gestion des erreurs
trap cleanup_on_error ERR

# CrÃ©ation du rÃ©pertoire de sauvegarde
mkdir -p "$APP_BACKUP_DIR"

# Sauvegarde de la base de donnÃ©es PostgreSQL
if [ -n "$DB_NAME" ]; then
    ynh_log_info "Sauvegarde de la base de donnÃ©es PostgreSQL"
    
    # CrÃ©ation du dump de la base de donnÃ©es
    ynh_postgresql_dump_db "$DB_NAME" "$APP_BACKUP_DIR/database.sql"
    
    # Compression du dump
    gzip "$APP_BACKUP_DIR/database.sql"
    
    # VÃ©rification de l'intÃ©gritÃ© du dump
    if [ ! -f "$APP_BACKUP_DIR/database.sql.gz" ]; then
        ynh_log_error "Ã‰chec de la sauvegarde de la base de donnÃ©es"
        exit 1
    fi
fi

# Sauvegarde des donnÃ©es Redis
if [ -n "$REDIS_DB" ]; then
    ynh_log_info "Sauvegarde des donnÃ©es Redis"
    
    # CrÃ©ation du dump Redis
    ynh_redis_dump_db "$REDIS_DB" "$APP_BACKUP_DIR/redis.rdb"
    
    # VÃ©rification de l'intÃ©gritÃ© du dump
    if [ ! -f "$APP_BACKUP_DIR/redis.rdb" ]; then
        ynh_log_error "Ã‰chec de la sauvegarde Redis"
        exit 1
    fi
fi

# Sauvegarde des fichiers de donnÃ©es
ynh_log_info "Sauvegarde des fichiers de donnÃ©es"
tar -czf "$APP_BACKUP_DIR/data.tar.gz" -C "$APP_DIR" data/

# Sauvegarde de la configuration
ynh_log_info "Sauvegarde de la configuration"
tar -czf "$APP_BACKUP_DIR/config.tar.gz" -C "$APP_DIR" config/

# Sauvegarde des logs
ynh_log_info "Sauvegarde des logs"
tar -czf "$APP_BACKUP_DIR/logs.tar.gz" -C "/var/log" "$APP_ID/"

# Sauvegarde du code source
ynh_log_info "Sauvegarde du code source"
tar -czf "$APP_BACKUP_DIR/source.tar.gz" -C "$APP_DIR" source/

# CrÃ©ation du fichier de mÃ©tadonnÃ©es
cat > "$APP_BACKUP_DIR/metadata.json" << EOF
{
  "app_id": "$APP_ID",
  "app_version": "$(ynh_app_setting_get "$APP_ID" "app_version")",
  "backup_date": "$(date -Iseconds)",
  "backup_type": "full",
  "database": {
    "name": "$DB_NAME",
    "type": "postgresql"
  },
  "redis": {
    "db": "$REDIS_DB"
  },
  "files": {
    "data": "data.tar.gz",
    "config": "config.tar.gz",
    "logs": "logs.tar.gz",
    "source": "source.tar.gz"
  }
}
EOF

# Calcul de la taille totale de la sauvegarde
BACKUP_SIZE=$(du -sh "$APP_BACKUP_DIR" | cut -f1)

# VÃ©rification de l'intÃ©gritÃ© de la sauvegarde
ynh_log_info "VÃ©rification de l'intÃ©gritÃ© de la sauvegarde"

# VÃ©rification des fichiers essentiels
REQUIRED_FILES=("metadata.json" "data.tar.gz" "config.tar.gz")
for file in "${REQUIRED_FILES[@]}"; do
    if [ ! -f "$APP_BACKUP_DIR/$file" ]; then
        ynh_log_error "Fichier de sauvegarde manquant : $file"
        exit 1
    fi
done

# VÃ©rification de la base de donnÃ©es
if [ -n "$DB_NAME" ] && [ ! -f "$APP_BACKUP_DIR/database.sql.gz" ]; then
    ynh_log_error "Sauvegarde de la base de donnÃ©es manquante"
    exit 1
fi

# VÃ©rification de Redis
if [ -n "$REDIS_DB" ] && [ ! -f "$APP_BACKUP_DIR/redis.rdb" ]; then
    ynh_log_error "Sauvegarde Redis manquante"
    exit 1
fi

# Log de la sauvegarde
ynh_log_info "Sauvegarde de $APP_ID terminÃ©e avec succÃ¨s"
ynh_log_info "Taille de la sauvegarde : $BACKUP_SIZE"
ynh_log_info "Emplacement : $APP_BACKUP_DIR"

# Message de fin
echo "âœ… Sauvegarde de $APP_ID terminÃ©e avec succÃ¨s !"
echo "ðŸ“¦ Taille : $BACKUP_SIZE"
echo "ðŸ“ Emplacement : $APP_BACKUP_DIR"
echo "ðŸ—„ï¸  Base de donnÃ©es : $(if [ -n "$DB_NAME" ]; then echo "âœ…"; else echo "âŒ"; fi)"
echo "ðŸ”´ Redis : $(if [ -n "$REDIS_DB" ]; then echo "âœ…"; else echo "âŒ"; fi)"
echo "ðŸ“„ Fichiers : âœ…"
echo "âš™ï¸  Configuration : âœ…"