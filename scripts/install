#!/bin/bash
set -eu
source /usr/share/yunohost/helpers
ynh_abort_if_errors

app="$YNH_APP_INSTANCE_NAME"

# 1) Lire les réponses d'install (helpers v2 : --app/--key)
domain="$(ynh_app_setting_get --app="$app" --key=domain)"
path_url="$(ynh_app_setting_get --app="$app" --key=path)"
init_main_permission="$(ynh_app_setting_get --app="$app" --key=init_main_permission || true)"

# 2) Port interne dédié à l'instance
port="$(ynh_app_setting_get --app="$app" --key=port || true)"
if [ -z "${port:-}" ]; then
  port="$(ynh_find_port --port=4090)"
  ynh_app_setting_set --app="$app" --key=port --value="$port"
fi

# 3) Répertoires / utilisateur
install_dir="/var/www/$app"
ynh_system_user_create --username="$app"
mkdir -p "$install_dir" "$install_dir/data" "$install_dir/config"
chown -R "$app:$app" "$install_dir"

# 4) Node LTS + pnpm (pour la suite réelle ; ici on reste smoke-test)
ynh_nodejs_install --package "$app" --nodejs_version "lts"
sudo -u "$app" bash -lc "corepack enable && corepack prepare pnpm@latest --activate || true"

# 5) Mini serveur Node (smoke test propre)
cat > "$install_dir/server.js" <<'JS'
const http = require('http');
const PORT = process.env.PORT || 4090;
const server = http.createServer((req, res) => {
  res.setHeader('Content-Type','text/html; charset=utf-8');
  res.end(`<h1>AFFiNE — paquet YunoHost</h1><p>Smoke test OK (helpers v2).</p>`);
});
server.listen(PORT, '127.0.0.1', () => console.log('listening on', PORT));
JS

# 6) .env depuis template minimal
cat > "$install_dir/.env" <<EOF
PORT=$port
NODE_ENV=production
EOF
chown "$app:$app" "$install_dir/.env"
chmod 640 "$install_dir/.env"

# 7) NGINX + systemd (helpers v2)
ynh_add_nginx_config --template="conf/nginx.conf" --domain="$domain" --path_url="$path_url" --port="$port"
ynh_add_systemd_config --template="conf/systemd/affine.service" --service="$app"

# 8) Démarrage + healthcheck
ynh_systemd_action --service_name="$app" --action=restart --log_path="systemd"
curl -fsS "http://127.0.0.1:$port" >/dev/null

# 9) Permissions si public
if [ "${init_main_permission:-}" = "visitors" ]; then
  ynh_permission_update --permission "main" --add "visitors"
fi

ynh_script_progression --message="Installation terminée." --last