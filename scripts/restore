#!/bin/bash

# Script de restauration pour AFFiNE
# BasÃ© sur example_ynh avec stubs utilisant ynh_*

set -e

# Chargement des helpers YunoHost
source /usr/share/yunohost/helpers

# Variables de configuration
APP_ID="affine"

# RÃ©cupÃ©ration de l'instance depuis les paramÃ¨tres YunoHost
INSTANCE_ID=$(ynh_app_setting_get "$APP_ID" "instance_id")
if [ -z "$INSTANCE_ID" ]; then
    ynh_log_error "Instance ID non trouvÃ©"
    exit 1
fi

# Configuration multi-instance
APP_USER="${APP_ID}_${INSTANCE_ID}"
APP_GROUP="${APP_ID}_${INSTANCE_ID}"
APP_DIR="/var/www/${APP_ID}_${INSTANCE_ID}"
APP_DATA_DIR="$APP_DIR/data"
APP_CONFIG_DIR="$APP_DIR/config"
APP_LOG_DIR="/var/log/${APP_ID}_${INSTANCE_ID}"
APP_SOURCE_DIR="$APP_DIR/source"
APP_BACKUP_DIR="/opt/yunohost/backup/${APP_ID}_${INSTANCE_ID}"

# RÃ©cupÃ©ration des paramÃ¨tres de l'application
DB_NAME=$(ynh_app_setting_get "$APP_ID" "db_name")
REDIS_DB=$(ynh_app_setting_get "$APP_ID" "redis_db")

# Fonction de nettoyage en cas d'erreur
cleanup_on_error() {
    ynh_clean_setup
    exit 1
}

# Gestion des erreurs
trap cleanup_on_error ERR

# VÃ©rification de l'existence de la sauvegarde
if [ ! -d "$APP_BACKUP_DIR" ]; then
    ynh_log_error "RÃ©pertoire de sauvegarde introuvable : $APP_BACKUP_DIR"
    exit 1
fi

# VÃ©rification du fichier de mÃ©tadonnÃ©es
if [ ! -f "$APP_BACKUP_DIR/metadata.json" ]; then
    ynh_log_error "Fichier de mÃ©tadonnÃ©es introuvable : $APP_BACKUP_DIR/metadata.json"
    exit 1
fi

# Lecture des mÃ©tadonnÃ©es de sauvegarde
BACKUP_VERSION=$(jq -r '.app_version' "$APP_BACKUP_DIR/metadata.json")
BACKUP_DATE=$(jq -r '.backup_date' "$APP_BACKUP_DIR/metadata.json")
BACKUP_TYPE=$(jq -r '.backup_type' "$APP_BACKUP_DIR/metadata.json")

ynh_log_info "Restauration de la sauvegarde du $BACKUP_DATE (version $BACKUP_VERSION)"

# ArrÃªt des services
ynh_systemd_action stop "$APP_ID"

# Sauvegarde de sÃ©curitÃ© avant restauration
ynh_backup_create "$APP_ID" "pre_restore_$(date +%Y%m%d_%H%M%S)"

# Restauration de la base de donnÃ©es PostgreSQL
if [ -f "$APP_BACKUP_DIR/database.sql.gz" ]; then
    ynh_log_info "Restauration de la base de donnÃ©es PostgreSQL"
    
    # DÃ©compression du dump
    gunzip -c "$APP_BACKUP_DIR/database.sql.gz" > "$APP_BACKUP_DIR/database.sql"
    
    # Restauration de la base de donnÃ©es
    ynh_postgresql_restore_db "$DB_NAME" "$APP_BACKUP_DIR/database.sql"
    
    # Nettoyage du fichier temporaire
    rm -f "$APP_BACKUP_DIR/database.sql"
    
    ynh_log_info "Base de donnÃ©es restaurÃ©e avec succÃ¨s"
else
    ynh_log_warning "Aucune sauvegarde de base de donnÃ©es trouvÃ©e"
fi

# Restauration des donnÃ©es Redis
if [ -f "$APP_BACKUP_DIR/redis.rdb" ]; then
    ynh_log_info "Restauration des donnÃ©es Redis"
    
    # ArrÃªt de Redis
    systemctl stop redis-server
    
    # Restauration du fichier RDB
    cp "$APP_BACKUP_DIR/redis.rdb" /var/lib/redis/dump.rdb
    
    # RedÃ©marrage de Redis
    systemctl start redis-server
    
    ynh_log_info "DonnÃ©es Redis restaurÃ©es avec succÃ¨s"
else
    ynh_log_warning "Aucune sauvegarde Redis trouvÃ©e"
fi

# Restauration des fichiers de donnÃ©es
if [ -f "$APP_BACKUP_DIR/data.tar.gz" ]; then
    ynh_log_info "Restauration des fichiers de donnÃ©es"
    
    # Suppression des donnÃ©es existantes
    rm -rf "$APP_DATA_DIR"
    
    # Restauration des donnÃ©es
    tar -xzf "$APP_BACKUP_DIR/data.tar.gz" -C "$APP_DIR"
    
    # Correction des permissions
    chown -R "$APP_USER:$APP_GROUP" "$APP_DATA_DIR"
    chmod -R 750 "$APP_DATA_DIR"
    
    ynh_log_info "Fichiers de donnÃ©es restaurÃ©s avec succÃ¨s"
else
    ynh_log_warning "Aucune sauvegarde de fichiers de donnÃ©es trouvÃ©e"
fi

# Restauration de la configuration
if [ -f "$APP_BACKUP_DIR/config.tar.gz" ]; then
    ynh_log_info "Restauration de la configuration"
    
    # Sauvegarde de la configuration actuelle
    cp -r "$APP_CONFIG_DIR" "$APP_CONFIG_DIR.backup"
    
    # Restauration de la configuration
    tar -xzf "$APP_BACKUP_DIR/config.tar.gz" -C "$APP_DIR"
    
    # Correction des permissions
    chown -R "$APP_USER:$APP_GROUP" "$APP_CONFIG_DIR"
    chmod -R 750 "$APP_CONFIG_DIR"
    
    ynh_log_info "Configuration restaurÃ©e avec succÃ¨s"
else
    ynh_log_warning "Aucune sauvegarde de configuration trouvÃ©e"
fi

# Restauration des logs
if [ -f "$APP_BACKUP_DIR/logs.tar.gz" ]; then
    ynh_log_info "Restauration des logs"
    
    # Restauration des logs
    tar -xzf "$APP_BACKUP_DIR/logs.tar.gz" -C "/var/log"
    
    # Correction des permissions
    chown -R "$APP_USER:$APP_GROUP" "$APP_LOG_DIR"
    chmod -R 750 "$APP_LOG_DIR"
    
    ynh_log_info "Logs restaurÃ©s avec succÃ¨s"
else
    ynh_log_warning "Aucune sauvegarde de logs trouvÃ©e"
fi

# Restauration du code source
if [ -f "$APP_BACKUP_DIR/source.tar.gz" ]; then
    ynh_log_info "Restauration du code source"
    
    # Sauvegarde du code source actuel
    cp -r "$APP_SOURCE_DIR" "$APP_SOURCE_DIR.backup"
    
    # Restauration du code source
    tar -xzf "$APP_BACKUP_DIR/source.tar.gz" -C "$APP_DIR"
    
    # Correction des permissions
    chown -R "$APP_USER:$APP_GROUP" "$APP_SOURCE_DIR"
    chmod -R 750 "$APP_SOURCE_DIR"
    
    ynh_log_info "Code source restaurÃ© avec succÃ¨s"
else
    ynh_log_warning "Aucune sauvegarde de code source trouvÃ©e"
fi

# RedÃ©marrage des services
ynh_systemd_action start "$APP_ID"

# VÃ©rification du fonctionnement
sleep 5
if ! ynh_systemd_action status "$APP_ID" > /dev/null 2>&1; then
    ynh_log_error "Le service $APP_ID ne dÃ©marre pas correctement aprÃ¨s restauration"
    
    # Restauration de la sauvegarde de sÃ©curitÃ©
    ynh_backup_restore "$APP_ID" "pre_restore_$(date +%Y%m%d_%H%M%S)"
    exit 1
fi

# Mise Ã  jour de la version dans les paramÃ¨tres
ynh_app_setting_set "$APP_ID" "app_version" "$BACKUP_VERSION"

# Nettoyage des sauvegardes temporaires
rm -rf "$APP_CONFIG_DIR.backup"
rm -rf "$APP_SOURCE_DIR.backup"

# Log de la restauration
ynh_log_info "Restauration de $APP_ID terminÃ©e avec succÃ¨s"
ynh_log_info "Version restaurÃ©e : $BACKUP_VERSION"
ynh_log_info "Date de sauvegarde : $BACKUP_DATE"

# Message de fin
echo "âœ… Restauration de $APP_ID terminÃ©e avec succÃ¨s !"
echo "ğŸ“… Date de sauvegarde : $BACKUP_DATE"
echo "ğŸ“ˆ Version : $BACKUP_VERSION"
echo "ğŸŒ AccÃ©dez Ã  votre application via : https://$(ynh_app_setting_get "$APP_ID" "domain")"
echo "ğŸ“Š Interface d'administration : https://$(ynh_app_setting_get "$APP_ID" "domain")/admin"