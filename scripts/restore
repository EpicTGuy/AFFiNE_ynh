#!/bin/bash
set -eu
source /usr/share/yunohost/helpers
ynh_abort_if_errors

app="$YNH_APP_INSTANCE_NAME"
domain="$(ynh_app_setting_get --app="$app" --key=domain)"
path_url="$(ynh_app_setting_get --app="$app" --key=path)"
port="$(ynh_app_setting_get --app="$app" --key=port)"

install_dir="/var/www/$app"

# Recréer user + dossiers vides
ynh_system_user_create --username="$app"
mkdir -p "$install_dir" "$install_dir/data" "$install_dir/config"
chown -R "$app:$app" "$install_dir"

# YunoHost restaurera .env/data/config depuis l'archive

# Régénérer NGINX + systemd
ynh_add_nginx_config --template="conf/nginx.conf" --domain="$domain" --path_url="$path_url" --port="$port"
ynh_add_systemd_config --template="conf/systemd/affine.service" --service="$app"
ynh_systemd_action --service_name="$app" --action=restart --log_path="systemd"

curl -fsS "http://127.0.0.1:$port" >/dev/null
ynh_print_info "Restore terminé pour $app."