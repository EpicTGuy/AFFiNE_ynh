#!/bin/bash

# Script de mise Ã  jour pour AFFiNE
# BasÃ© sur example_ynh avec stubs utilisant ynh_*

set -e

# Chargement des helpers YunoHost
source /usr/share/yunohost/helpers

# Variables de configuration
APP_ID="affine"
APP_USER="affine"
APP_GROUP="affine"
APP_DIR="/var/www/$APP_ID"
APP_DATA_DIR="$APP_DIR/data"
APP_CONFIG_DIR="$APP_DIR/config"
APP_LOG_DIR="/var/log/$APP_ID"
APP_SOURCE_DIR="$APP_DIR/source"

# RÃ©cupÃ©ration des paramÃ¨tres de l'application
OLD_VERSION=$(ynh_app_setting_get "$APP_ID" "app_version")
NEW_VERSION="0.1.0"
DB_NAME=$(ynh_app_setting_get "$APP_ID" "db_name")
REDIS_DB=$(ynh_app_setting_get "$APP_ID" "redis_db")

# Fonction de nettoyage en cas d'erreur
cleanup_on_error() {
    ynh_clean_setup
    exit 1
}

# Gestion des erreurs
trap cleanup_on_error ERR

# VÃ©rification de la version actuelle
if [ "$OLD_VERSION" = "$NEW_VERSION" ]; then
    echo "â„¹ï¸  L'application est dÃ©jÃ  Ã  la version $NEW_VERSION"
    exit 0
fi

# Sauvegarde de sÃ©curitÃ© avant la mise Ã  jour
ynh_backup_create "$APP_ID" "pre_upgrade_$OLD_VERSION"

# ArrÃªt des services
ynh_systemd_action stop "$APP_ID"

# Sauvegarde de la configuration actuelle
cp "$APP_CONFIG_DIR/config.json" "$APP_CONFIG_DIR/config.json.backup"

# Mise Ã  jour du code source
cd "$APP_SOURCE_DIR"
ynh_exec_as "$APP_USER" git fetch origin
ynh_exec_as "$APP_USER" git checkout main
ynh_exec_as "$APP_USER" git pull origin main

# Mise Ã  jour des dÃ©pendances Node.js
ynh_exec_as "$APP_USER" npm install --production

# Migration de la base de donnÃ©es si nÃ©cessaire
if [ "$OLD_VERSION" != "$NEW_VERSION" ]; then
    ynh_log_info "Migration de la base de donnÃ©es de $OLD_VERSION vers $NEW_VERSION"
    
    # ExÃ©cution des migrations
    # TODO: ImplÃ©menter les vraies migrations AFFiNE
    ynh_exec_as "$APP_USER" npm run migrate || true
    
    # VÃ©rification de l'intÃ©gritÃ© des donnÃ©es
    ynh_exec_as "$APP_USER" npm run check-db || true
fi

# Mise Ã  jour de la configuration si nÃ©cessaire
if [ -f "$APP_CONFIG_DIR/config.json.new" ]; then
    mv "$APP_CONFIG_DIR/config.json.new" "$APP_CONFIG_DIR/config.json"
fi

# Mise Ã  jour du service systemd
ynh_update_systemd_config "$APP_ID" "$APP_USER" "$APP_GROUP" "$APP_SOURCE_DIR" "$(ynh_app_setting_get "$APP_ID" "app_port")"

# Mise Ã  jour de la configuration NGINX
ynh_update_nginx_config "$APP_ID" "conf/nginx.conf"

# RedÃ©marrage des services
ynh_systemd_action start "$APP_ID"

# VÃ©rification du fonctionnement
sleep 5
if ! ynh_systemd_action status "$APP_ID" > /dev/null 2>&1; then
    ynh_log_error "Le service $APP_ID ne dÃ©marre pas correctement"
    
    # Restauration de la sauvegarde
    ynh_backup_restore "$APP_ID" "pre_upgrade_$OLD_VERSION"
    exit 1
fi

# Mise Ã  jour de la version dans les paramÃ¨tres
ynh_app_setting_set "$APP_ID" "app_version" "$NEW_VERSION"

# Nettoyage des sauvegardes temporaires
rm -f "$APP_CONFIG_DIR/config.json.backup"

# Log de la mise Ã  jour
ynh_log_info "Mise Ã  jour de $APP_ID de $OLD_VERSION vers $NEW_VERSION terminÃ©e avec succÃ¨s"

# Message de fin
echo "âœ… $APP_ID a Ã©tÃ© mis Ã  jour avec succÃ¨s !"
echo "ğŸ“ˆ Version : $OLD_VERSION â†’ $NEW_VERSION"
echo "ğŸŒ AccÃ©dez Ã  votre application via : https://$(ynh_app_setting_get "$APP_ID" "domain")"
echo "ğŸ“Š Interface d'administration : https://$(ynh_app_setting_get "$APP_ID" "domain")/admin"