#!/bin/bash
set -eu
source /usr/share/yunohost/helpers
ynh_abort_if_errors

app="$YNH_APP_INSTANCE_NAME"
port="$(ynh_app_setting_get --app="$app" --key=port || true)"
if [ -z "${port:-}" ]; then
  port="$(ynh_find_port --port=4090)"
  ynh_app_setting_set --app="$app" --key=port --value="$port"
fi

# Assure que Node est encore là
ynh_nodejs_install --package "$app" --nodejs_version "lts" || true

# Rien de spécial à recompiler en smoke test ; on redémarre simplement
ynh_systemd_action --service_name="$app" --action=restart --log_path="systemd"
curl -fsS "http://127.0.0.1:$port" >/dev/null